<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>1.5-Java锁机制</title><link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px !important; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }
  .typora-export #write::after { height: 0px; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none 0s ease 0s; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="mermaid"] svg, [lang="flow"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
svg[id^="mermaidChart"] { line-height: 1em; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
mark .md-meta { color: rgb(0, 0, 0); opacity: 0.3 !important; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

html {
    font-size: 16px;
}

body {
    font-family: "Open Sans","Clear Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}
#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    padding-bottom: .3em;
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
   padding-bottom: .3em;
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}
h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table tr td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}


</style>
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><h1><a name="java-锁机制" class="md-header-anchor"></a><span>Java 锁机制</span></h1><h3><a name="syncronized" class="md-header-anchor"></a><span>syncronized</span></h3><p><span>给一个变量/一段代码加锁，线程拿到锁之后，才能修改一个变量/执行一段代码</span></p><ul><li><code>wait()</code></li><li><code>notify()</code></li></ul><p><span>synchronized关键字可以作用于方法或者代码块，最主要有以下几种使用方式：</span></p><p><img src="images/20190819164021481.png" referrerpolicy="no-referrer" alt="img"></p><h4><a name="syncronized-实现原理" class="md-header-anchor"></a><span>syncronized 实现原理？</span></h4><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">Object</span> <span class="cm-variable">o</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">Object</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">synchronized</span> (<span class="cm-variable">o</span>) {}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>添加 synchronized 之后，生成的字节码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="asm" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="asm"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">0</span> <span class="cm-keyword">new</span> <span class="cm-comment">#2 &lt;java/lang/Object&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">3</span> <span class="cm-keyword">dup</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">4</span> <span class="cm-keyword">invokespecial</span> <span class="cm-comment">#1 &lt;java/lang/Object.&lt;init&gt;&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">7</span> <span class="cm-keyword">astore_1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">8</span> <span class="cm-keyword">aload_1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">9</span> <span class="cm-keyword">dup</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">10</span> <span class="cm-keyword">astore_2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">11</span> <span class="cm-keyword">monitorenter</span> // 获取锁</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">12</span> <span class="cm-keyword">aload_2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">13</span> <span class="cm-keyword">monitorexit</span> // 释放锁</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">14</span> <span class="cm-keyword">goto</span> <span class="cm-keyword">22</span> (+8)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">17</span> <span class="cm-keyword">astore_3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">18</span> <span class="cm-keyword">aload_2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">19</span> <span class="cm-keyword">monitorexit</span> // 兜底：如果发生异常，自动释放锁</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">20</span> <span class="cm-keyword">aload_3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">21</span> <span class="cm-keyword">athrow</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">22</span> <span class="cm-keyword">return</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><h5><a name="1字节码层面accsynchronizedmonitorentermonitorexit重量级锁）" class="md-header-anchor"></a><span>1、字节码层面：ACC_SYNCHRONIZED，monitorenter，monitorexit（重量级锁）</span></h5><p><span>事实上，只有在JDK1.6之前，synchronized的实现才会直接调用ObjectMonitor的enter和exit，这种锁被称之为重量级锁。从JDK6开始，HotSpot虚拟机开发团队对Java中的锁进行优化，如增加了适应性自旋、锁消除、锁粗化、轻量级锁和偏向锁等优化策略。</span></p><p><a href='https://juejin.im/post/6844903918653145102' target='_blank' class='url'>https://juejin.im/post/6844903918653145102</a></p><ul><li><h5><a name="accsynchronized把-syncronized-加在方法上时的字节码" class="md-header-anchor"></a><span>ACC_SYNCHRONIZED：把 syncronized 加在方法上时的字节码</span></h5><p><span>方法调用时，调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先持有 monitor（虚拟机规范中用的是管程一词），然后再执行方法，最后再方法完成(无论是正常完成还是非正常完成)时释放monitor</span></p><blockquote><h5><a name="accsynchronized" class="md-header-anchor"></a><span>ACC_SYNCHRONIZED：</span></h5><p><span>方法级别的同步是隐式的，作为方法调用的一部分。同步方法的常量池中会有一个ACC_SYNCHRONIZED标志。</span>
<span>当调用一个设置了ACC_SYNCHRONIZED标志的方法，执行线程需要先获得monitor锁，然后开始执行方法，方法执行之后再释放monitor锁，当方法不管是正常return还是抛出异常都会释放对应的monitor锁。</span>
<span>在这期间，如果其他线程来请求执行方法，会因为无法获得监视器锁而被阻断住。</span>
<span>如果在方法执行过程中，发生了异常，并且方法内部并没有处理该异常，那么在异常被抛到方法外面之前监视器锁会被自动释放。</span></p></blockquote></li><li><h5><a name="monitorenter-monitorexit把-syncronized-用于对象时的字节码" class="md-header-anchor"></a><span>monitorenter, monitorexit：把 syncronized 用于对象时的字节码</span></h5><p><span>代码块的同步是利用 monitorenter 和 monitorexit 这两个字节码指令。它们分别位于同步代码块的开始和结束位置。当 jvm 执行到 monitorenter 指令时，当前线程试图获取 monitor 对象的所有权</span></p><ul><li><span>如果未加锁或者已经被当前线程所持有，把锁计数器 +1</span></li><li><span>当执行 monitorexit 指令时，锁计数器 -1</span></li><li><span>当锁计数器为 0 时，锁被释放</span></li><li><span>如果获取monitor对象失败，该线程进入阻塞状态，直到其他线程释放锁。</span></li></ul><p>&nbsp;</p></li></ul><blockquote><h5><a name="monitorenter" class="md-header-anchor"></a><span>monitorenter：</span></h5><p><span>每个对象都与一个 monitor 相关联。当且仅当拥有所有者时（被拥有），monitor才会被锁定。执行到monitorenter指令的线程，会尝试去获得对应的monitor，如下：</span></p><p><span>每个对象维护着一个记录着被锁次数的计数器, 对象未被锁定时，该计数器为0。线程进入monitor（执行monitorenter指令）时，会把计数器设置为1.</span>
<span>当同一个线程再次获得该对象的锁的时候，计数器再次自增.</span>
<span>当其他线程想获得该monitor的时候，就会阻塞，直到计数器为0才能成功。</span></p><h5><a name="monitorexit" class="md-header-anchor"></a><span>monitorexit：</span></h5><p><span>monitor的拥有者线程才能执行 monitorexit指令。</span></p><p><span>线程执行monitorexit指令，就会让monitor的计数器减一。如果计数器为0，表明该线程不再拥有monitor。其他线程就允许尝试去获得该monitor了。</span></p></blockquote><ul><li><p><span>monitor 监视器</span></p><p><span>monitor是什么？ 它可以理解为一种同步工具，或者说是同步机制，它通常被描述成一个对象。</span><strong><span>操作系统的管程</span></strong><span> 是概念原理，在 HotSpot 中，Monitor（管程）是由 ObjectMonitor 实现的。</span></p><p><img src="images/20190819165049560.png" referrerpolicy="no-referrer" alt="img"></p><p><span>Java Monitor 的工作机理如图所示：</span></p><p><img src="images/20190819165244208.png" referrerpolicy="no-referrer" alt="img"></p><p><span>对象是如何跟 monitor关联的呢？直接看图：</span></p><p><img src="images/20190819165423366.png" referrerpolicy="no-referrer" alt="img"></p><p><span>对象里有对象头，对象头里面有Mark Word，Mark Word 指针指向了 monitor</span></p></li></ul><h5><a name="2jvm-层面" class="md-header-anchor"></a><span>2、JVM 层面</span></h5><ul><li><span>C, C++ 调用了操作系统提供的同步机制，在 win 和 linux 上不同</span></li></ul><h5><a name="3os-和硬件层面" class="md-header-anchor"></a><span>3、OS 和硬件层面</span></h5><ul><li><span>X86 : </span><code>lock cmpxchg</code><span> / xxx</span></li><li><span>lock 是处理多处理器之间的总线锁问题</span></li></ul><p>&nbsp;</p><h3><a name="syncronized-锁升级过程" class="md-header-anchor"></a><span>syncronized 锁升级过程</span></h3><p><span>早期（jdk 1.2 以前）所有的 syncronized 都是重量级锁，由操作系统管理。后来进行了优化，锁升级过程。</span></p><p><span>偏向锁、自旋锁都是用户空间完成，JVM自己管理；重量级锁需要向内核申请</span></p><p><img src="images/image-20200726164025491.png" referrerpolicy="no-referrer" alt="image-20200726164025491"></p><p><span>markword 组成</span></p><p><img src="images/image-20200726163848419.png" referrerpolicy="no-referrer" alt="image-20200726163848419"></p><h4><a name="偏向锁" class="md-header-anchor"></a><span>偏向锁</span></h4><ul><li><p><span>普通对象加了 syncronized，会加上偏向锁。偏向锁默认是打开的，但是有一个时延，如果要观察到偏向锁，应该设定参数</span></p></li><li><p><span>我们知道，Vector，StringBuffer 都有很多使用了 syncronized 的同步方法，但是在工业实践中，我们通常是在单线程的时候使用它的，</span><strong><span>没有必要 </span></strong><span>设计 </span><strong><span>锁竞争机制</span></strong><span>。</span></p><p><span>为了在没有竞争的情况下减少锁开销，偏向锁偏向于第一个获得它的线程，</span><strong><span>把第一个访问的 线程 id 写到 markword 中</span></strong><span>，而不去真正加锁。如果一直没有被其他线程竞争，则持有偏向锁的线程将不需要进行同步</span></p><p><span>默认情况，偏向锁有个时延，默认是4秒。why? 因为JVM虚拟机自己有一些默认启动的线程，里面有好多sync代码，这些sync代码启动时就知道肯定会有竞争，如果使用偏向锁，就会造成偏向锁不断的进行锁撤销和锁升级的操作，效率较低。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-XX</span>:<span class="cm-operator">+</span>UseBiasedLocking <span class="cm-attribute">-XX</span><span class="cm-def">:BiasedLockingStartupDelay</span><span class="cm-operator">=</span><span class="cm-number">0</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>设定上述参数，new Object () - &gt; 101 偏向锁 -&gt; 线程ID为0 -&gt; 匿名偏向 Anonymous BiasedLock ，指还没有偏向任何一个线程。打开偏向锁，new出来的对象，默认就是一个可偏向匿名对象 101（或者 sleep 5000 之后再打印也可以看到偏向锁）</span></p></li></ul><p>&nbsp;</p><h4><a name="轻量级锁也叫-自旋锁--无锁--cas）" class="md-header-anchor"></a><span>轻量级锁（也叫 自旋锁 / 无锁 / CAS）</span></h4><ul><li><p><span>偏向锁时，有人来竞争锁，操作系统把 </span><strong><span>偏向锁撤销</span></strong><span>，进行 </span><strong><span>自旋锁（轻量级锁）竞争</span></strong><span>。</span></p></li><li><p><span>在没有竞争的前提下，减少 </span><strong><span>重量级锁使用操作系统 mutex 互斥量</span></strong><span> 产生的性能消耗</span></p><p><span>虚拟机在当前线程的栈帧中建立一个 </span><strong><span>锁记录 (Lock Record, LR) </span></strong><span>空间，存储锁对象目前 markword 的拷贝。</span></p><p><span>虚拟机 </span><strong><span>使用 CAS 尝试把对象的 markword 更新为指向 LR 的指针</span></strong><span>，如果更新成功即代表该线程拥有了锁，锁标志位将转变为 00，表示处于轻量级锁定状态。</span></p></li><li><p><span>CAS 是一种乐观锁：</span><code>cas(v, a, b)</code><span> 变量v，期待a，修改值b</span></p></li><li><p><span>Java 中调用了 native 的 </span><code>conpareAndSwapXXX()</code><span> 方法</span></p></li><li><p><span>每个人在自己的线程内部生成一个自己LR（Lock Record锁记录），两个线程通过自己的方式尝试将 LR 写门上，竞争成功的开始运行，竞争失败的一直自旋等待。</span></p></li><li><p><span>实际上是汇编指令 </span><code>lock cmpxchg</code><span>，硬件层面实现：在操作过程中不允许被其他CPU打断，避免CAS在写数据的时候被其他线程打断，相比操作系统级别的锁，效率要高很多。</span></p><blockquote><p><code>LOCK</code><span> 本身不是一个指令：它是一个指令前缀，该指令必须是对存储器（ INC, XCHG, CMPXCHG等）进行 读 – 修改 – 写操作的指令，在这种情况下，它是在所保存的地址处包含字的</span><code>incl (%ecx)</code><span>指令在</span><code>ecx</code><span>寄存器中。</span></p><p><code>LOCK</code><span> 前缀确保CPU在操作期间拥有适当的caching行的独占所有权，并提供某些额外的订购保证。 这可以通过声明一个总线锁来实现，但是CPU将尽可能地避免这种情况。</span></p><p><span>CPU在执行cmpxchg指令之前会执行lock锁定总线,实际是锁定北桥信号。现在的主板貌似没有南北桥了，集成到cpu里面了 </span><a href='http://www.360doc.com/content/18/0216/10/44130189_730197818.shtml' target='_blank' class='url'>http://www.360doc.com/content/18/0216/10/44130189_730197818.shtml</a></p></blockquote></li><li><p><span>如何解决ABA问题？</span></p><ul><li><span>基础数据类型即使出现了ABA，一般问题不大。</span></li><li><span>解决方式：加版本号，后面检查的时候连版本号一起检查。</span></li><li><span>Atomic里面有个带版本号的类 </span><code>AtomicStampedReference</code><span>，目前还没有人在面试的时候遇到过。</span></li></ul></li><li><p><span>线程始终得不到锁会自旋消耗 CPU</span></p></li></ul><p>&nbsp;</p><h4><a name="重量级锁" class="md-header-anchor"></a><span>重量级锁</span></h4><ul><li><p><span>轻量级锁再竞争，升级为重量级锁</span></p><ul><li><span>重量级锁向 </span><strong><span>Linux 内核</span></strong><span> 申请锁 mutex， CPU从3级-0级系统调用，线程挂起，进入等待队列，等待操作系统的调度，然后再映射回用户空间。他有一个等待队列，不需要 CAS 消耗 CPU 时间。</span></li></ul></li><li><p><span>在 markword 中记录 ObjectMonitor，是 JVM 用 C++ 写的一个 Object</span></p></li></ul><p>&nbsp;</p><h4><a name="自旋锁什么时候升级为重量级锁" class="md-header-anchor"></a><span>自旋锁，什么时候升级为重量级锁？</span></h4><p><span>竞争加剧：有线程超过10次自旋， -XX:PreBlockSpin， 或者自旋线程数超过CPU核数的一半， 1.6之后，加入自适应自旋 Adapative Self Spinning ， JVM自己控制自旋次数，不需要你设置参数了。所以你在做实验的时候，会发现有时候 syncronized 并不比 AtomicInteger 效率低。</span></p><p><span>升级重量级锁：-&gt; 向操作系统申请资源，linux mutex , CPU从3级-0级系统调用，线程挂起，进入等待队列，等待操作系统的调度，然后再映射回用户空间</span></p><p>&nbsp;</p><h4><a name="为什么有自旋锁还需要重量级锁" class="md-header-anchor"></a><span>为什么有自旋锁，还需要重量级锁？</span></h4><p><span>自旋是消耗CPU资源的，如果锁的时间长，或者自旋线程多，CPU会被大量消耗</span></p><p><span>重量级锁有等待队列，所有拿不到锁的进入等待队列，不需要消耗CPU资源</span></p><p>&nbsp;</p><h4><a name="偏向锁是否一定比自旋锁效率高" class="md-header-anchor"></a><span>偏向锁，是否一定比自旋锁效率高？</span></h4><p><span>不一定，在明确知道会有多线程竞争的情况下，偏向锁肯定会涉及锁撤销，这时候直接使用自旋锁</span></p><p><span>例如，JVM 启动过程，会有很多线程竞争（明确知道，比如在刚启动的之后，肯定有很多线程要争抢内存的位置），所以，默认情况启动时不打开偏向锁，过一段儿时间再打开。</span></p><p>&nbsp;</p><h4><a name="锁重入" class="md-header-anchor"></a><span>锁重入</span></h4><p><span>sychronized是可重入锁</span></p><p><span>重入次数必须记录，因为要解锁几次必须得对应</span></p><p><span>偏向锁、自旋锁，重入次数存放在线程栈，让 LR + 1</span></p><p><span>重量级锁 -&gt; ? ObjectMonitor 字段上</span></p><p><strong><span>如果计算过对象的 hashCode，则对象无法进入偏向状态！</span></strong></p><blockquote><p><span>轻量级锁重量级锁的hashCode存在与什么地方？</span></p><p><span>答案：线程栈中，轻量级锁的LR中，或是代表重量级锁的ObjectMonitor的成员中</span></p></blockquote><p>&nbsp;</p><p>&nbsp;</p><h3><a name="reentrantlock-可重入锁" class="md-header-anchor"></a><span>ReentrantLock 可重入锁</span></h3><p><span>ReentrantLock 和 synchronized 都是可重入锁</span></p><p><a href='https://blog.csdn.net/fuyuwei2015/article/details/83719444' target='_blank' class='url'>https://blog.csdn.net/fuyuwei2015/article/details/83719444</a><span> ReentrantLock 原理</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">TestLock</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">InterruptedException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ExecutorService</span> <span class="cm-variable">executorService</span> <span class="cm-operator">=</span> <span class="cm-variable">Executors</span>.<span class="cm-variable">newCachedThreadPool</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ReentrantLock</span> <span class="cm-variable">reentrantLock</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ReentrantLock</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">count</span>[] <span class="cm-operator">=</span> {<span class="cm-number">0</span>};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10000</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">executorService</span>.<span class="cm-variable">submit</span>(() <span class="cm-operator">-&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">reentrantLock</span>.<span class="cm-variable">lock</span>(); &nbsp;<span class="cm-comment">// 获取锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">count</span>[<span class="cm-number">0</span>]<span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">reentrantLock</span>.<span class="cm-variable">unlock</span>(); &nbsp;<span class="cm-comment">// 释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">executorService</span>.<span class="cm-variable">shutdown</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">executorService</span>.<span class="cm-variable">awaitTermination</span>(<span class="cm-number">1</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">HOURS</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">count</span>[<span class="cm-number">0</span>]); &nbsp;<span class="cm-comment">// 10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 493px;"></div><div class="CodeMirror-gutters" style="display: none; height: 493px;"></div></div></div></pre><p><code>private Lock lock = new ReentrantLock();</code></p><ul><li><code>lock.lock()</code><span> 获取锁</span></li><li><code>lock.unlock()</code><span> 释放锁</span></li></ul><p><span>ReentrantLock 主要利用 CAS + AQS(AbstractQueuedSynchronizer) 来实现。</span></p><p><span>它支持公平锁和非公平锁，两者的实现类似。</span></p><h4><a name="lock-与-unlock-实现原理" class="md-header-anchor"></a><span>lock() 与 unlock() 实现原理</span></h4><h5><a name="可重入锁" class="md-header-anchor"></a><span>可重入锁</span></h5><p><span>可重入锁是指，同一个线程可以多次获取同一把锁。ReentrantLock和synchronized都是可重入锁。</span></p><h5><a name="可中断锁" class="md-header-anchor"></a><span>可中断锁</span></h5><p><span>可中断锁是指线程尝试获取锁的过程中，是否可以响应中断。synchronized是不可中断锁，而ReentrantLock则提供了中断功能。</span></p><h5><a name="公平锁与非公平锁" class="md-header-anchor"></a><span>公平锁与非公平锁</span></h5><p><span>公平锁是指，多个线程同时尝试获取同一把锁时，获取锁的顺序按照线程达到顺序，非公平锁则允许线程“插队”。</span></p><p><span>synchronized是非公平锁，而ReentrantLock的默认实现是非公平锁，但是也可以设置为公平锁。</span></p><p><span>ReentrantLock提供了两个构造器，可以指定使用公平锁和非公平锁。分别是：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">ReentrantLock</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sync</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">NonfairSync</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">ReentrantLock</span>(<span class="cm-variable-3">boolean</span> <span class="cm-variable">fair</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sync</span> <span class="cm-operator">=</span> <span class="cm-variable">fair</span> <span class="cm-operator">?</span> <span class="cm-keyword">new</span> <span class="cm-variable">FairSync</span>() : <span class="cm-keyword">new</span> <span class="cm-variable">NonfairSync</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>默认初始化为 NonfairSync 对象，即非公平锁。由 lock() 和 unlock() 的源码可以看到，它们只是分别调用了 sync.acquire(1); 和 sync.release(1); 方法。</span></p><p><span>Test.java</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">reentrantLock</span>.<span class="cm-variable">lock</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>ReentrantLock.java</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Sync</span> <span class="cm-variable">sync</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">abstract</span> <span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">Sync</span> <span class="cm-keyword">extends</span> <span class="cm-variable">AbstractQueuedSynchronizer</span> {...}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">lock</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sync</span>.<span class="cm-variable">acquire</span>(<span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>AbstractQueuedSynchronizer.java</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">void</span> <span class="cm-def">acquire</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">arg</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">tryAcquire</span>(<span class="cm-variable">arg</span>) <span class="cm-operator">&amp;&amp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">acquireQueued</span>(<span class="cm-variable">addWaiter</span>(<span class="cm-variable">Node</span>.<span class="cm-variable">EXCLUSIVE</span>), <span class="cm-variable">arg</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">selfInterrupt</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><h5><a name="cas-操作-compareandswap" class="md-header-anchor"></a><span>CAS 操作 (CompareAndSwap)</span></h5><p><span>CAS操作简单的说就是比较并交换。CAS 操作包含三个操作数：</span><strong><span>内存位置(V)、预期原值(A)、新值(B)</span></strong><span>。如果内存位置的值与预期原值相匹配，那么处理器会自动将该位置值更新为新值。否则，处理器不做任何操作。无论哪种情况，它都会在 CAS 指令之前返回该位置的值。</span></p><p><span>CAS 有效地说明了 </span><strong><span>我认为位置 V 应该包含值 A；如果包含该值，则将 B 放到这个位置；否则，不要更改该位置，只告诉我这个位置现在的值即可。</span></strong></p><p><span>Java并发包(java.util.concurrent)中大量使用了CAS操作,涉及到并发的地方都调用了sun.misc.Unsafe类方法进行CAS操作。</span></p><p>&nbsp;</p><p><img src="images/image-20200806110142620.png" referrerpolicy="no-referrer" alt="image-20200806110142620"></p><h3><a name="volatile" class="md-header-anchor"></a><span>volatile</span></h3><p><span>作用：一个线程中的改变，在另一个线程中可以立刻看到。</span></p><ul><li><span>保证线程的可见性</span></li><li><span>禁止指令的重排序</span></li></ul><h5><a name="什么是指令重排序" class="md-header-anchor"></a><span>什么是指令重排序？</span></h5><p><span>为了提高性能，编译器和处理器通常会对指令进行重排序，重排序指从源代码到指令序列的重排序，分为三种：</span></p><p><span>① 编译器优化的重排序，编译器在不改变单线程程序语义的前提下可以重排语句的执行顺序。</span></p><p><span>② 指令级并行的重排序，如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。</span></p><p><span>③ 内存系统的重排序。</span></p><p>&nbsp;</p><h4><a name="dcl-单例要不要加-volitile" class="md-header-anchor"></a><span>DCL 单例要不要加 volitile？</span></h4><p><span>需要。为了防止指令重排序导致拿到半初始化的变量。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">SingleInstance</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">SingleInstance</span>() {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-variable">SingleInstance</span> <span class="cm-variable">INSTANCE</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">SingleInstance</span> <span class="cm-variable">getInstance</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">INSTANCE</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">SingleInstance</span>.<span class="cm-keyword">class</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">INSTANCE</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) { &nbsp;<span class="cm-comment">// Double Check Lock</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">INSTANCE</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">SingleInstance</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">INSTANCE</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><p><code>INSTANCE = new SingleInstance()</code><span> 创建实例对象时，单条语句编译后形成的指令，并不是一个原子操作，</span><strong><span>可能该条语句的部分指令未得到执行，就被切换到另一个线程了</span></strong><span>，它是分三步来完成的：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="asm"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="asm"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">0</span> &nbsp;<span class="cm-keyword">new</span> &nbsp;<span class="cm-comment">#2 &lt;T&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">3</span> &nbsp;<span class="cm-keyword">dup</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">4</span> &nbsp;<span class="cm-keyword">invokespecial</span> &nbsp;<span class="cm-comment">#3  &lt;T.&lt;init&gt;&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">7</span> &nbsp;<span class="cm-keyword">astore_1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">8</span> &nbsp;<span class="cm-keyword">return</span>　</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><ol start='' ><li><span>创建内存空间。</span></li><li><span>执行构造函数，初始化（init）</span></li><li><span>将 INSTANCE 引用指向分配的内存空间</span></li></ol><p><span>JVM 为了优化指令，允许指令重排序，有可能按照 </span><strong><span>1 –&gt; 3 –&gt; 2</span></strong><span> 步骤来执行。</span></p><p><span>这时候，当线程 a 执行步骤 3 完毕，在执行步骤 2 之前，被切换到线程 b 上，这时候 INSTANCE 判断为非空，此时线程 b 直接来到 </span><code>return instance</code><span> 语句，拿走 INSTANCE 然后使用，导致拿到半初始化的变量。</span></p><p>&nbsp;</p><h4><a name="硬件和-jvm-如何保证特定情况下不乱序" class="md-header-anchor"></a><span>硬件和 JVM 如何保证特定情况下不乱序？</span></h4><h5><a name="1硬件层面针对x86-cpu）" class="md-header-anchor"></a><span>1、硬件层面（针对x86 CPU）</span></h5><ul><li><code>sfence</code><span>（store fence）: 在</span><strong><span>sfence指令前的写操作</span></strong><span>，必须在</span><strong><span>sfence指令后的写操作前</span></strong><span>完成。</span></li><li><code>lfence</code><span>（load fence）：在</span><strong><span>lfence指令前的读操作</span></strong><span>，必须在</span><strong><span>lfence指令后的读操作前</span></strong><span>完成。</span></li></ul><p><span>原子指令，如x86上的</span><code>lock …</code><span> 指令是一个 Full Barrier，执行时会</span><strong><span>锁住内存子系统</span></strong><span>来确保执行顺序，甚至</span><strong><span>跨多个CPU</span></strong><span>。</span></p><p><span>Software Locks 通常使用了</span><strong><span>内存屏障</span></strong><span>或</span><strong><span>原子指令</span></strong><span>来实现</span><strong><span>变量可见性</span></strong><span>和</span><strong><span>保持程序顺序</span></strong><span>.</span></p><h5><a name="2jvm层面jsr133）" class="md-header-anchor"></a><span>2、JVM层面（JSR133）</span></h5><ul><li><p><span>LoadLoad屏障</span></p><ul><li><code>Load语句1; LoadLoad屏障; Load语句2</code></li><li><span>在Load2及后续读取操作要读取的数据被访问前，保证Load1要读取的数据被读取完毕。</span></li></ul></li><li><p><span>StoreStore屏障</span></p><ul><li><code>Store语句1; StoreStore屏障; Store语句2</code></li><li><span>在Store2及后续写入操作执行前，保证Store1的写入操作对其它处理器可见。</span></li></ul></li><li><p><span>LoadStore屏障</span></p><ul><li><code>Load语句1; LoadStore屏障; Store语句2</code></li><li><span>在Store2及后续写入操作被刷出前，保证Load1要读取的数据被读取完毕。</span></li></ul></li><li><p><span>StoreLoad屏障</span></p><ul><li><code>Store语句1; StoreLoad屏障; Load语句2</code></li><li><span>在Load2及后续所有读取操作执行前，保证Store1的写入对所有处理器可见。</span></li></ul></li></ul><p>&nbsp;</p><h4><a name="volitile-的实现原理" class="md-header-anchor"></a><span>volitile 的实现原理？</span></h4><h5><a name="1字节码层面" class="md-header-anchor"></a><span>1、字节码层面</span></h5><ul><li><span>ACC_VOLATILE</span></li></ul><h5><a name="2jvm-层面-n1619" class="md-header-anchor"></a><span>2、JVM 层面</span></h5><p><span>对于volatile内存区的读写，都加屏障</span></p><ul><li><strong><span>StoreStoreBarrier</span></strong>
<span>volatile 写操作</span>
<strong><span>StoreLoadBarrier</span></strong></li><li><strong><span>LoadLoadBarrier</span></strong>
<span>volatile 读操作</span>
<strong><span>LoadStoreBarrier</span></strong></li></ul><h5><a name="3os-和硬件层面-n1626" class="md-header-anchor"></a><span>3、OS 和硬件层面</span></h5><ul><li><p><span>使用 volatile 变量进行写操作，汇编指令带有 lock 前缀，相当于一个内存屏障，后面的指令不能重排到内存屏障之前。</span></p><p><span>使用 lock 前缀引发两件事：</span></p><p><span>① 将当前处理器缓存行的数据写回系统内存。</span></p><p><span>②使其他处理器的缓存无效。</span></p><p><span>相当于对缓存变量做了一次 store 和 write 操作，让 volatile 变量的修改对其他处理器立即可见。</span></p></li><li><p><span>windows lock 指令实现</span></p></li><li><p><span>MESI实现</span></p></li></ul><p>&nbsp;</p><h4><a name="happens-before-原则" class="md-header-anchor"></a><span>happens-before 原则</span></h4><p><span>JVM 规定，重排序必须遵守的规则——“先行发生原则”，由具体的JVM实现。</span></p><p><span>对于会改变结果的重排序， JMM 要求编译器和处理器必须禁止。</span></p><p><span>对于不会改变结果的重排序，JMM 不做要求。</span></p><p><strong><span>程序次序规则：</span></strong><span>一个线程内写在前面的操作先行发生于后面的。</span>
<strong><span>管程锁定规则：</span></strong><span> unlock 操作先行发生于后面对同一个锁的 lock 操作。</span>
<strong><span>volatile 规则：</span></strong><span>对 volatile 变量的写操作先行发生于后面的读操作。</span>
<strong><span>线程启动规则：</span></strong><span>线程的 start 方法先行发生于线程的每个动作。</span>
<strong><span>线程终止规则：</span></strong><span>线程中所有操作先行发生于对线程的终止检测。</span>
<strong><span>对象终结规则：</span></strong><span>对象的初始化先行发生于 finalize 方法。</span>
<strong><span>传递性：</span></strong><span>如果操作 A 先行发生于操作 B，操作 B 先行发生于操作 C，那么操作 A 先行发生于操作 C 。</span></p><p>&nbsp;</p><h4><a name="as-if-serial" class="md-header-anchor"></a><span>as-if-serial</span></h4><p><span>不管如何重排序，单线程执行结果不会改变，看起来像是串行的一样。编译器和处理器必须遵循 as-if-serial 语义。</span></p><p><span>为了遵循 as-if-serial，编译器和处理器不会对存在</span><strong><span>数据依赖</span></strong><span>关系的操作重排序，因为这种重排序会改变执行结果。但是如果操作之间不存在数据依赖关系，这些操作就可能被编译器和处理器重排序。</span></p><p><strong><span>as-if-serial 保证单线程程序的执行结果不变，happens-before 保证正确同步的多线程程序的执行结果不变。这两种语义的目的，都是为了在不改变程序执行结果的前提下尽可能提高程序执行并行度。</span></strong></p><p>&nbsp;</p><p>&nbsp;</p><h3><a name="juc包下新的同步机制" class="md-header-anchor"></a><span>JUC包下新的同步机制</span></h3><h4><a name="cas" class="md-header-anchor"></a><span>CAS</span></h4><p><span>Compare And Swap (Compare And Exchange) / 自旋 / 自旋锁 / 无锁 （无重量锁）</span></p><p><span>因为经常配合循环操作，直到完成为止，所以泛指一类操作</span></p><p><span>cas(v, a, b) ，变量v，期待值a, 修改值b</span></p><p><img src="images/image-20200726152455721.png" alt="image-20200726152455721" style="zoom:50%;" /></p><p><span>ABA问题：你的女朋友在离开你的这段儿时间经历了别的人，自旋就是你空转等待，一直等到她接纳你为止。</span></p><p><span>ABA 问题的解决方式：加版本号（数值型 / bool 型）</span></p><p>&nbsp;</p><p><span>atomic 包里的类基本都是使用 Unsafe 实现的，Unsafe 只提供三种 CAS 方法：compareAndSwapInt、compareAndSwapLong 和 compareAndSwapObject，例如原子更新 Boolean 是先转成整形再使用 compareAndSwapInt </span></p><h5><a name="atomicinteger-底层实现原理" class="md-header-anchor"></a><span>AtomicInteger 底层实现原理</span></h5><p><code>getAndIncrement()</code><span> 方法，实现以原子方式将当前的值加 1，实现原理：</span></p><ol start='' ><li><p><span>在 for 死循环中取得 AtomicInteger 里存储的数值</span></p></li><li><p><span>对 AtomicInteger 当前的值加 1 </span></p></li><li><p><span>调用 compareAndSet 方法进行原子更新，先检查当前数值是否等于 expect，如果等于则说明当前值没有被其他线程修改，则将值更新为 next，否则会更新失败返回 false，程序会进入 for 循环重新进行 compareAndSet 操作。</span></p><p><strong><span>源码级别的实现原理：</span></strong></p></li></ol><ul><li><p><code>getAndIncrement()</code><span>调用 Unsafe 类 </span><code>getAndAddInt(...)</code><span> </span></p></li><li><p><code>getAndAddInt(...)</code><span> 调用 </span><code>this.compareAndSwapInt(...)</code><span>， native 方法， hotspot  cpp 实现</span></p></li><li><p><span>这个方法在 unsafe.cpp 中</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UNSAFE_ENTRY</span>(<span class="cm-variable">jboolean</span>, <span class="cm-variable">Unsafe_CompareAndSwapInt</span>(<span class="cm-variable">JNIEnv</span> <span class="cm-operator">*</span><span class="cm-variable">env</span>, <span class="cm-variable">jobject</span> <span class="cm-variable">unsafe</span>, <span class="cm-variable">jobject</span> <span class="cm-variable">obj</span>, <span class="cm-variable">jlong</span> <span class="cm-variable">offset</span>, <span class="cm-variable">jint</span> <span class="cm-variable">e</span>, <span class="cm-variable">jint</span> <span class="cm-variable">x</span>))</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">UnsafeWrapper</span>(<span class="cm-string">"Unsafe_CompareAndSwapInt"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">oop</span> <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">JNIHandles</span>::<span class="cm-variable">resolve</span>(<span class="cm-variable">obj</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">jint</span><span class="cm-operator">*</span> <span class="cm-variable">addr</span> <span class="cm-operator">=</span> (<span class="cm-variable">jint</span> <span class="cm-operator">*</span>) <span class="cm-variable">index_oop_from_field_offset_long</span>(<span class="cm-variable">p</span>, <span class="cm-variable">offset</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> (<span class="cm-variable">jint</span>)(<span class="cm-variable">Atomic</span>::<span class="cm-variable">cmpxchg</span>(<span class="cm-variable">x</span>, <span class="cm-variable">addr</span>, <span class="cm-variable">e</span>)) <span class="cm-operator">==</span> <span class="cm-variable">e</span>; <span class="cm-comment">// 注意这里 cmpxchg</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UNSAFE_END</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre></li><li><p><code>cmpxchg</code><span> 在 atomic.cpp 中，里面调用了另外一个 </span><code>cmpxchg</code><span> ，最后你回来到 atomic_linux_x86.inline.hpp ， </span><strong><span>93行</span></strong><span> </span><code>cmpxchg</code><span> ，用内联汇编的方式实现。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// atomic_linux_x86.inline.hpp</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">inline</span> <span class="cm-variable">jint</span> &nbsp; &nbsp; <span class="cm-variable">Atomic</span>::<span class="cm-variable">cmpxchg</span> &nbsp;  (<span class="cm-variable">jint</span> &nbsp; &nbsp; <span class="cm-variable">exchange_value</span>, <span class="cm-keyword">volatile</span> <span class="cm-variable">jint</span><span class="cm-operator">*</span> &nbsp; &nbsp; <span class="cm-variable">dest</span>, <span class="cm-variable">jint</span> &nbsp; &nbsp; <span class="cm-variable">compare_value</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">mp</span> <span class="cm-operator">=</span> <span class="cm-variable">os</span>::<span class="cm-variable">is_MP</span>(); <span class="cm-comment">// is_MP = Multi Processor 多处理器需要加锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">__asm__</span> <span class="cm-keyword">volatile</span> (<span class="cm-variable">LOCK_IF_MP</span>(<span class="cm-operator">%</span><span class="cm-number">4</span>) <span class="cm-string">"cmpxchgl %1,(%3)"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  : <span class="cm-string">"=a"</span> (<span class="cm-variable">exchange_value</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  : <span class="cm-string">"r"</span> (<span class="cm-variable">exchange_value</span>), <span class="cm-string">"a"</span> (<span class="cm-variable">compare_value</span>), <span class="cm-string">"r"</span> (<span class="cm-variable">dest</span>), <span class="cm-string">"r"</span> (<span class="cm-variable">mp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  : <span class="cm-string">"cc"</span>, <span class="cm-string">"memory"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">exchange_value</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><span>jdk8u: atomic_linux_x86.inline.hpp</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="c"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define LOCK_IF_MP(mp) "cmp $0, " #mp "; je 1f; lock; 1: "</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>最终实现：</span><strong><span>cmpxchg</span></strong><span> ，相当于使用 CAS 的方法修改变量值，这个在 CPU 级别是有原语支持的。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="asm"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="asm"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">lock</span> <span class="cm-keyword">cmpxchg</span> // 这个指令，在执行这条指令的过程中，是不允许被其他线程打断的</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre></li></ul><p>&nbsp;</p><p>&nbsp;</p><h4><a name="juc-包下的一些用于同步的类" class="md-header-anchor"></a><span>JUC 包下的一些用于同步的类</span></h4><ul><li><p><span>AtomicInteger，上面讲了</span></p></li><li><p><span>AtomicLong</span></p></li><li><p><span>ReentrantLock</span></p><ul><li><span>可重入锁</span></li><li><span>必须要finally中手动释放锁</span></li><li><span>可以指定为公平锁</span></li></ul></li><li><p><span>CountDownLatch</span></p><ul><li><span>门栓，每次调用 </span><code>countDown</code><span> 方法时计数器减 1，</span><code>await</code><span> 方法会阻塞当前线程直到计数器变为0</span></li><li><span>和Join的对比：CountDownLatch可以更灵活，因为在一个线程中，CountDownLatch可以根据你的需要countDown很多次。而join是等待所有join进来的线程结束之后，才继续执行被join的线程。</span></li></ul></li><li><p><span>CyclicBarrier</span></p><ul><li><span>循环栅栏</span></li><li><span>这里有一个栅栏，什么时候人满了，就把栅栏推倒，哗啦哗啦的都放出去，出去之后，栅栏又重新起来，再来人，满了推倒，以此类推。</span></li><li><span>是基于同步到达某个点的信号量触发机制，作用是让一组线程到达一个屏障时被阻塞，直到最后一个线程到达屏障才会解除。</span></li><li><span>适用于多线程计算数据，最后合并计算结果的应用场景。</span></li></ul></li><li><p><span>Phaser</span></p><ul><li><span>按照不同的阶段来对线程进行执行</span></li><li><span>场景：n个人全到场才能吃饭，全吃完才能离开，全离开才能打扫</span></li></ul></li><li><p><span>ReadWriteLock</span></p><ul><li><strong><span>读写锁</span></strong><span>，其实就是 </span><strong><span>shared 共享锁</span></strong><span> 和 </span><strong><span>exclusive 排他锁</span></strong></li><li><span>读写有很多种情况，比如，你数据库里的某条数据，你放在内存里读的时候特别多，你改的次数并不多。这时候将读写的锁分开，会大大提高效率，因为读操作本质上是可以允许多个线程同时进行的。</span></li></ul></li><li><p><span>Semaphore</span></p><ul><li><p><span>信号量，类似于令牌桶，用来控制同时访问特定资源的线程数量，通过协调各个线程以保证合理使用公共资源。信号量可以用于流量控制，特别是公共资源有限的应用场景，比如数据库连接。</span></p></li><li><p><span>可以用于限流：最多允许多少个 线程同时在运行</span></p></li><li><p><span>Semaphore 的构造方法参数接收一个 int 值，表示可用的许可数量即最大并发数。</span></p><p><span>使用 </span><code>acquire</code><span> 方法获得一个许可证，使用 </span><code>release</code><span> 方法归还许可，用 </span><code>tryAcquire</code><span> 尝试获得许可</span></p></li></ul></li><li><p><span>Exchanger</span></p><ul><li><span>可以想象 exchanger 是一个容器，用来在两个线程之间交换变量，用于线程间协作</span></li><li><span>两个线程通过 </span><code>exchange</code><span> 方法交换数据，第一个线程执行 </span><code>exchange</code><span> 方法后会阻塞等待第二个线程执行该方法，当两个线程都到达同步点时这两个线程就可以交换数据，将本线程生产出的数据传递给对方。应用场景包括遗传算法、校对工作等。</span></li></ul></li><li><p><span>LockSupport</span></p><ul><li><span>在线程中调用</span><code>LockSupport.park()</code><span>，阻塞当前线程</span></li><li><code>LockSupport.unpark(t)</code><span> 唤醒 </span><code>t</code><span> 线程</span></li><li><span>unpark 方法可以先于 park 方法执行，unpark 依然有效</span></li><li><span>这两个方法的实现是由 Unsafe 类提供的，原理是操作线程的一个变量在0,1之间切换，控制阻塞和唤醒</span></li><li><span>AQS 就是调用这两个方法进行线程的阻塞和唤醒的。</span></li></ul><p>&nbsp;</p></li></ul><h4><a name="aqs-原理abstractqueuedsyncronizer抽象的队列式同步器）" class="md-header-anchor"></a><span>AQS 原理（AbstractQueuedSyncronizer，抽象的队列式同步器）</span></h4><p><span>是一个用于构建锁和同步容器的框架，AQS解决了在实现同步容器时设计的大量细节问题。事实上，concurrent 包内许多类都是基于 AQS 构建的。</span></p><p><span>如 ReentrantLock, Semaphore, CountDownLatch, CyclicBarrier 等并发类均是基于 AQS 实现的，具体用法：通过继承 AQS 实现其模板方法，然后将子类作为同步组件的内部类。</span></p><h5><a name="reentrantlock的基本实现可以概括为" class="md-header-anchor"></a><span>ReentrantLock的基本实现可以概括为：</span></h5><p><span>先通过CAS尝试获取锁。如果此时已经有线程占据了锁，那就加入AQS队列并且被挂起。当锁被释放之后，排在CLH 队列队首的线程会被唤醒，然后CAS再次尝试获取锁。在这个时候，如果：</span></p><ul><li><strong><span>非公平锁</span></strong><span>：如果同时还有另一个线程进来尝试获取，那么有可能会让这个线程抢先获取；</span></li><li><strong><span>公平锁</span></strong><span>：如果同时还有另一个线程进来尝试获取，当它发现自己不是在队首的话，就会排到队尾，由队首的线程获取到锁。</span></li></ul><p><img src="images/image-20200806104607345.png" alt="image-20200806104607345" style="zoom:50%;" /></p><p><span>它使用一个 volatile int state 变量作为共享资源。每当有新线程请求资源时，都会进入一个 </span><strong><span>FIFO 等待队列</span></strong><span>，只有当持有锁的线程释放锁资源后该线程才能持有资源。</span></p><p><span>等待队列表示 </span><strong><span>排队等待锁的线程</span></strong><span>，通过 </span><strong><span>双向链表</span></strong><span> 实现，线程被封装在链表的 Node 节点中。队头节点称作“哨兵节点”或者“哑节点”，它不与任何线程关联。其他节点与等待线程关联，每个节点维护一个等待状态 waitStatus。</span></p><h5><a name="node-的等待状态包括" class="md-header-anchor"></a><span>Node 的等待状态包括：</span></h5><ol start='' ><li><span>CANCELLED（线程已取消）</span></li><li><span>SIGNAL（线程需要唤醒）</span></li><li><span>CONDITION （线程正在等待）</span></li><li><span>PROPAGATE（后继节点会传播唤醒操作，只在共享模式下起作用）。</span></li></ol><p><span>AQS 的底层是 </span><strong><span>CAS + volitile</span></strong><span>，用 CAS 替代了锁整个链表的操作</span></p><p>&nbsp;</p><h4><a name="varhandle-类" class="md-header-anchor"></a><span>VarHandle 类</span></h4><p><span>Varhandle 为 java 9 新加功能，用来代替 Unsafe 供开发者使用。</span></p><p><span>相当于引用，可以指向任何对象或者对象里的某个属性，相当于可以直接操作二进制码，效率上比反射高，并封装有compareAndSet，getAndSet等方法，可以原子性地修改所指对象的值。比如对long的原子性赋值可以使用VarHandle</span></p><ul><li><span>普通属性也可以进行原子操作</span></li><li><span>比反射快，直接操作二进制码</span></li></ul><p>&nbsp;</p></div>
</body>
</html>