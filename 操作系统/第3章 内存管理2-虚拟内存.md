# 第三章 内存管理2 - 虚拟内存

### 虚拟内存的定义

基于局部性原理，在程序装入时，将会用到的部分装入内存，暂时不用的部分留在外存，程序就可以执行。在操作系统的管理下，在用户看来似乎有一个 **比实际内存大得多** 的内存，这就是 **虚拟内存**。

- 若访问信息不在内存，由操作系统从将信息从外存调入内存。（请求调页）

- 若内存空间不够，将暂时不用的信息换出到外存。（页面置换）



### 虚拟内存的特征

1. 多次性：作业运行无需一次全部装入内存，允许多次调入内存。
2. 对换性：作业运行时无需常驻内存，允许在运行过程中换入换出。
3. 虚拟性：从逻辑上扩充了内存的容量，用户看到的内存容量远大于实际容量。



### 虚拟内存的实现

#### 请求分页存储管理

##### 页表机制

| 页号  | 内存块号 | 状态位 | 访问字段 | 修改位 | 外存地址 |
| ----- | -------- | ------ | -------- | ------ | -------- |
| **0** | c        | 1      | 0        | 0      | x        |
| **1** | b        | 1      | 10       | 0      | y        |
| **2** | 无       | 0      | 6        | 1      | z        |

在基本分页存储管理的基础上，增加了：

- 状态位：表示页面是否已在内存中
- 访问字段：记录最近被访问过几次 / 上次访问的时间，供置换算法选择换出页面时间时参考
- 修改位：表示页面调入内存后是否被修改过，只有修改过的页面才需要在置换时写回外存
- 外存地址：页面在外存中存放的位置



##### 缺页中断（内中断）

在请求分页系统中，若要访问的页面不在内存，则产生一个 **缺页中断**，由操作系统的 **缺页中断处理程序** 处理。

缺页的进程阻塞，放入阻塞队列。调页完成后唤醒，放回就绪队列。

- 将目标页面调入内存，必要时换出页面

- 缺页中断属于内中断中的“故障”，即可能被系统修复的异常

  <img src="images/image-20201110122801556.png" alt="image-20201110122801556" style="zoom:67%;" />

- 一条指令在执行过程中可能产生多次缺页中断，如 copy A to B



##### 地址变换机构

重点关注与基本分页不同的地方：

- 找到页表项时，需要检查是否在内存中
- 若页面不在内存中，需要请求调页
- 若内存空间不够，需要换出页面
- 页面调入内存后，需要修改响应页表项



##### 请求分页中的地址变换过程

<img src="images/image-20201110121721452.png" alt="image-20201110121721452" style="zoom:40%;" />



##### 页面置换算法

###### 1、最佳置换算法 OPT

每次选择 **最长时间不再被访问** 的页面淘汰，保证缺页率最低。由于无法预测未来，实际上是无法实现的。

<img src="images/image-20201110124018431.png" alt="image-20201110124018431" style="zoom:45%;" />



###### 2、先进先出置换算法 FIFO

每次淘汰 **最早进入内存** 的页面。将页面根据先后顺序排成一个队列，每次淘汰队头页面即可。

① 分配 3 个内存块时，缺页次数 9 次

<img src="images/image-20201110124634778.png" alt="image-20201110124634778" style="zoom:57%;" />

② 分配 4 个内存块时，缺页次数 10 次

<img src="images/image-20201110124901575.png" alt="image-20201110124901575" style="zoom: 57%;" />

**Belady 异常**：当为进程分配的物理块数增大时，缺页次数不减反增的异常现象。只有 FIFO 算法会产生 Belady 异常，并没有考虑到金橙世纪运行时规律。算法性能差。



###### 3、最近最久未使用算法 LRU

每次淘汰 **最近最久未使用** 的页面。性能好，但是开销大。需要硬件支持。

<img src="images/image-20201110125507996.png" alt="image-20201110125507996" style="zoom:57%;" />



###### 4、时钟置换算法 CLOCK / 最近未使用算法 NRU









#### 请求分段存储管理

#### 请求段页式存储管理

